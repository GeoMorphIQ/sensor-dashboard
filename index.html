<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Structural Health Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #333333;
            --heading-color: #1a73e8;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #e0e0e0;
            --alert-bg: #fce8e6;
            --alert-border: #d93025;
            --warning-bg: #fff0c7;
            --warning-border: #f9ab00;
        }

        body.dark-mode {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --heading-color: #64b5f6;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-color: #424242;
            --alert-bg: #4d2323;
            --alert-border: #d93025;
            --warning-bg: #524214;
            --warning-border: #f9ab00;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--heading-color);
            font-weight: 700;
        }

        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; }
        input:checked + .slider { background-color: var(--heading-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .card, .chart-container, .log-container {
            background: var(--card-bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }
        
        .card h3 { margin-top: 0; font-weight: 600; }
        .card p { font-size: 2.5em; font-weight: 700; margin: 0; color: var(--heading-color); }
        .card p .unit { font-size: 0.4em; font-weight: 400; color: var(--text-color); }
        
        .alert { background-color: var(--alert-bg); border-left: 5px solid var(--alert-border); }
        .warning { background-color: var(--warning-bg); border-left: 5px solid var(--warning-border); }
        
        .alert p, .warning p { font-size: 2em; }

        .chart-container, .log-container { 
            grid-column: 1 / -1; 
            overflow-x: auto;     /* Fixes horizontal scrolling */
            position: relative;  /* <-- THIS IS THE FIX FOR THE INFINITE GROWING */
        }

        .log-container h3 { margin-top: 0; }
        #log-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry .timestamp { color: #888; font-size: 0.9em; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ðŸ§± Structural Health Monitor</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </header>

    <div class="main-grid">
        <div class="card">
            <h3>Health</h3>
            <p><span id="health">--</span><span class="unit">%</span></p>
        </div>
        <div class="card">
            <h3>PZT Voltage</h3>
            <p><span id="voltage">--</span><span class="unit"> mV</span></p>
        </div>
        <div id="earthquakeCard" class="card">
            <h3>Earthquake Alert</h3>
            <p id="earthquakeAlert">NO</p>
        </div>
        <div id="weakBrickCard" class="card">
            <h3>Weak Brick Warning</h3>
            <p id="weakBrickWarning">NO</p>
        </div>

        <div class="chart-container">
            <h3>Temperature Readings (Â°C)</h3>
            <canvas id="tempChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Accelerometer Readings (g)</h3>
            <canvas id="accelChart"></canvas>
        </div>

        <div class="log-container">
            <h3>Event Log</h3>
            <div id="log-box">
                </div>
        </div>
    </div>
</div>

<script>
    // IMPORTANT: Use the same Render backend URL
    const API_URL = 'https://my-brick-project.onrender.com/api/data';
    const MAX_CHART_POINTS = 20;

    // --- Chart Initialization ---
    const createChart = (ctx, label) => new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            scales: { y: { beginAtZero: false } },
            animation: { duration: 500 },
            maintainAspectRatio: false
        }
    });

    const tempCtx = document.getElementById('tempChart').getContext('2d');
    const tempChart = createChart(tempCtx, 'Temperature');
    tempChart.data.datasets.push({ label: 'Surface Temp', borderColor: 'rgba(255, 99, 132, 1)', tension: 0.3, fill: false, data: [] });
    tempChart.data.datasets.push({ label: 'Inner Temp', borderColor: 'rgba(54, 162, 235, 1)', tension: 0.3, fill: false, data: [] });

    const accelCtx = document.getElementById('accelChart').getContext('2d');
    const accelChart = createChart(accelCtx, 'Acceleration');
    accelChart.data.datasets.push({ label: 'Accel X', borderColor: 'rgba(255, 206, 86, 1)', tension: 0.3, fill: false, data: [] });
    accelChart.data.datasets.push({ label: 'Accel Y', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.3, fill: false, data: [] });
    accelChart.data.datasets.push({ label: 'Accel Z', borderColor: 'rgba(153, 102, 255, 1)', tension: 0.3, fill: false, data: [] });
    
    const updateChart = (chart, labels, ...newDatas) => {
        if (chart.data.labels.length > MAX_CHART_POINTS) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        chart.data.labels.push(labels);
        newDatas.forEach((data, index) => chart.data.datasets[index].data.push(data));
        chart.update();
    };

    // --- Data Fetching and UI Update ---
    async function fetchData() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const apiResponse = await response.json(); // The full response from the backend
            
            const data = apiResponse.latestSensorData;
            const logs = apiResponse.eventLog;

            if (!data || Object.keys(data).length === 0) return; // Don't update if no data
            
            // Update cards
            document.getElementById('health').textContent = data.health?.toFixed(1) || '--';
            document.getElementById('voltage').textContent = data.voltage?.toFixed(2) || '--';

            // Update alerts
            const earthquakeCard = document.getElementById('earthquakeCard');
            document.getElementById('earthquakeAlert').textContent = data.earthquakeAlert ? 'YES!' : 'NO';
            earthquakeCard.classList.toggle('alert', data.earthquakeAlert);

            const weakBrickCard = document.getElementById('weakBrickCard');
            document.getElementById('weakBrickWarning').textContent = data.weakBrickWarning ? 'YES' : 'NO';
            weakBrickCard.classList.toggle('warning', data.weakBrickWarning);
            
            // Update charts
            const timestamp = new Date().toLocaleTimeString();
            updateChart(tempChart, timestamp, data.surfaceTemp, data.innerTemp);
            updateChart(accelChart, timestamp, data.accelX, data.accelY, data.accelZ);

            // Update event log
            const logBox = document.getElementById('log-box');
            logBox.innerHTML = ''; // Clear previous logs
            if (logs && logs.length > 0) {
                logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `<span class="timestamp">${log.timestamp}</span>${log.message}`;
                    logBox.appendChild(logEntry);
                });
            } else {
                logBox.innerHTML = '<div class="log-entry">No events recorded.</div>';
            }

        } catch (error) {
            console.error('Failed to fetch sensor data:', error);
        }
    }

    // --- Theme Switcher ---
    const themeToggle = document.getElementById('checkbox');
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme) {
        document.body.classList.add(currentTheme);
        if (currentTheme === 'dark-mode') {
            themeToggle.checked = true;
        }
    }
    themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light-mode');
        }
    });

    setInterval(fetchData, 2000);
    fetchData(); // Initial fetch
</script>

</body>
</html>
