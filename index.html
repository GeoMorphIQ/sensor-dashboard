<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>geoMorpgIq - Structural Health Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- MODIFIED: Red/White (Light) Theme --- */
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --text-color: #333333;
            --heading-color: #d32f2f; /* Strong Red */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-color: #e0e0e0;
            --alert-bg: #fce8e6;
            --alert-border: #d93025;
            --warning-bg: #fff0c7;
            --warning-border: #f9ab00;
            --success-color: #2e7d32;
        }

        /* --- MODIFIED: Red/Black (Dark) Theme --- */
        body.dark-mode {
            --bg-color: #121212;
            --card-bg-color: rgba(30, 30, 30, 0.7);
            --text-color: #e0e0e0;
            --heading-color: #f44336; /* Brighter Red */
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-color: #424242;
            --alert-bg: #4d2323;
            --alert-border: #d93025;
            --warning-bg: #524214;
            --warning-border: #f9ab00;
            --success-color: #81c784;
        }
        
        @keyframes background-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 var(--alert-border); }
            70% { box-shadow: 0 0 10px 10px rgba(217, 48, 37, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 48, 37, 0); }
        }
        body.dark-mode .pulse.alert {
            animation: pulse-dark 1.5s infinite;
        }
        .pulse.warning {
            animation: pulse-warning 1.5s infinite;
        }
        @keyframes pulse-dark {
            0% { box-shadow: 0 0 0 0 var(--alert-border); }
            70% { box-shadow: 0 0 10px 10px rgba(217, 48, 37, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(217, 48, 37, 0); }
        }
        @keyframes pulse-warning {
            0% { box-shadow: 0 0 0 0 var(--warning-border); }
            70% { box-shadow: 0 0 10px 10px rgba(249, 171, 0, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(249, 171, 0, 0); }
        }


        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
            
            /* --- MODIFIED: Animated gradient for light theme --- */
            background: linear-gradient(-45deg, var(--bg-color), #ffcdd2, var(--bg-color), #ffccbc);
            background-size: 400% 400%;
            animation: background-pan 15s ease infinite;
        }
        
        body.dark-mode {
             /* --- MODIFIED: Animated gradient for dark theme --- */
            background: linear-gradient(-45deg, var(--bg-color), #6a0000, var(--bg-color), #4e0000);
            background-size: 400% 400%;
            animation: background-pan 15s ease infinite;
        }

        .container {
            max-width: 1200px;
            margin: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 25px;
            /* --- MODIFIED: Header gradient to use red --- */
            background: linear-gradient(90deg, var(--heading-color) 0%, #b71c1c 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-placeholder {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #fff;
            margin-right: 15px;
            font-size: 24px;
            border: none;
        }
        
        header h1 {
            color: #ffffff;
            font-weight: 700;
            margin: 0;
        }

        header h2 {
            color: #f0f2f5;
            font-weight: 400;
            font-size: 1.2em;
            margin: 0;
        }

        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; }
        /* This now automatically uses the red --heading-color variable */
        input:checked + .slider { background-color: var(--heading-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .card, .chart-container, .log-container {
            background: var(--card-bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            backdrop-filter: blur(10px);
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }
        .card:nth-child(2) { animation-delay: 0.05s; }
        .card:nth-child(3) { animation-delay: 0.1s; }
        .card:nth-child(4) { animation-delay: 0.15s; }
        .card:nth-child(5) { animation-delay: 0.2s; }
        .card:nth-child(6) { animation-delay: 0.25s; } /* --- MODIFIED: Adjusted animation delay --- */
        .chart-container:nth-of-type(1) { animation-delay: 0.3s; }
        .chart-container:nth-of-type(2) { animation-delay: 0.35s; }
        .log-container { animation-delay: 0.4s; }


        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }
        
        .card h3 { 
            margin-top: 0; 
            font-weight: 600; 
            display: flex;
            align-items: center;
        }
        .card h3 i, .chart-container h3 i, .log-container h3 i {
            margin-right: 12px;
            font-size: 1.1em;
            /* This now automatically uses the red --heading-color variable */
            color: var(--heading-color);
            width: 20px;
            text-align: center;
        }

        /* This now automatically uses the red --heading-color variable */
        .card p { font-size: 2.5em; font-weight: 700; margin: 0; color: var(--heading-color); }
        .card p .unit { font-size: 0.4em; font-weight: 400; color: var(--text-color); }
        
        .card p i {
            font-size: 0.8em;
            margin-right: 10px;
            vertical-align: middle;
        }
        .alert p { color: var(--alert-border); }
        .warning p { color: var(--warning-border); }
        #earthquakeCard:not(.alert) p, #weakBrickCard:not(.warning) p {
            color: var(--success-color); 
        }


        .alert { background-color: var(--alert-bg); border-left: 5px solid var(--alert-border); }
        .warning { background-color: var(--warning-bg); border-left: 5px solid var(--warning-border); }
        
        .alert p, .warning p { font-size: 2em; }

        .chart-container {
            grid-column: 1 / -1;
            overflow-x: auto;
            position: relative;
            height: 400px;
        }
        .chart-container h3, .log-container h3 {
            display: flex;
            align-items: center;
        }

        .log-container { 
            grid-column: 1 / -1; 
            overflow-x: auto;
            position: relative;
        }

        .log-container h3 { margin-top: 0; }
        #log-box {
            height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background: var(--bg-color); 
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry .timestamp { color: #888; font-size: 0.9em; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo-container">
            <div class="logo-placeholder"><i class="fas fa-microchip"></i></div>
            <h1>geoMorpgIq</h1>
        </div>
        <h2>Structural Health Monitor</h2>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </header>
    <div class="main-grid">
        <div class="card">
            <h3><i class="fas fa-heartbeat"></i>Health</h3>
            <p><span id="health">--</span><span class="unit">%</span></p>
        </div>

        <div class="card">
            <h3><i class="fas fa-tachometer-alt"></i>Stress Level</h3>
            <p><span id="stressLevel">--</span><span class="unit">mV</span></p>
        </div>
        <div class="card">
            <h3><i class="fas fa-thermometer-half"></i>Surface Temp</h3>
            <p><span id="surfaceTemp">--</span><span class="unit">°C</span></p>
        </div>

        <div class="card">
            <h3><i class="fas fa-thermometer-full"></i>Inner Temp</h3>
            <p><span id="innerTemp">--</span><span class="unit">°C</span></p>
        </div>
        
        <div id="earthquakeCard" class="card">
            <h3><i class="fas fa-broadcast-tower"></i>Earthquake Alert</h3>
            <p id="earthquakeAlert">--</p>
        </div>
        <div id="weakBrickCard" class="card">
            <h3><i class="fas fa-exclamation-circle"></i>Weak Brick Warning</h3>
            <p id="weakBrickWarning">--</p>
        </div>

        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i>Temperature Readings (°C)</h3>
            <canvas id="tempChart"></canvas>
        </div>

        <div class="chart-container">
            <h3><i class="fas fa-wave-square"></i>Accelerometer Readings (g)</h3>
            <canvas id="accelChart"></canvas>
        </div>

        <div class="log-container">
            <h3><i class="fas fa-list-alt"></i>Event Log</h3>
            <div id="log-box">
                </div>
        </div>
    </div>
</div>

<script>
    // --- NO CHANGES to API URL or Chart Config ---
    const API_URL = 'https://my-brick-project.onrender.com/api/data';
    const MAX_CHART_POINTS = 20;

    const createChart = (ctx, label) => new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            scales: { 
                y: { 
                    beginAtZero: false,
                    ticks: { color: 'var(--text-color)' },
                    grid: { color: 'var(--border-color)' }
                },
                x: {
                    ticks: { color: 'var(--text-color)' },
                    grid: { color: 'var(--border-color)' }
                }
            },
            animation: { duration: 500 },
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'var(--text-color)' } }
            }
        }
    });

    const tempCtx = document.getElementById('tempChart').getContext('2d');
    const tempChart = createChart(tempCtx, 'Temperature');
    tempChart.data.datasets.push({ label: 'Surface Temp', borderColor: 'rgba(255, 99, 132, 1)', tension: 0.3, fill: false, data: [] });
    tempChart.data.datasets.push({ label: 'Inner Temp', borderColor: 'rgba(54, 162, 235, 1)', tension: 0.3, fill: false, data: [] }); // Keeping this blue for contrast

    const accelCtx = document.getElementById('accelChart').getContext('2d');
    const accelChart = createChart(accelCtx, 'Acceleration');
    accelChart.data.datasets.push({ label: 'Accel X', borderColor: 'rgba(255, 206, 86, 1)', tension: 0.3, fill: false, data: [] });
    accelChart.data.datasets.push({ label: 'Accel Y', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.3, fill: false, data: [] });
    accelChart.data.datasets.push({ label: 'Accel Z', borderColor: 'rgba(153, 102, 255, 1)', tension: 0.3, fill: false, data: [] });
    
    const updateChart = (chart, labels, ...newDatas) => {
        if (chart.data.labels.length > MAX_CHART_POINTS) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        chart.data.labels.push(labels);
        newDatas.forEach((data, index) => chart.data.datasets[index].data.push(data));
        chart.update();
    };

    async function fetchData() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const apiResponse = await response.json();
            
            const data = apiResponse.latestSensorData;
            const logs = apiResponse.eventLog;

            if (!data || Object.keys(data).length === 0) return;
            
            // --- JAVASCRIPT LINE ADDED HERE ---
            document.getElementById('health').textContent = data.health?.toFixed(1) || '--';
            document.getElementById('stressLevel').textContent = data.voltage?.toFixed(2) || '--'; // <-- THIS LINE IS NEW
            document.getElementById('surfaceTemp').textContent = data.surfaceTemp?.toFixed(2) || '--';
            document.getElementById('innerTemp').textContent = data.innerTemp?.toFixed(2) || '--';
            // --- END OF JAVASCRIPT CHANGE ---

            const earthquakeCard = document.getElementById('earthquakeCard');
            const earthquakeAlertP = document.getElementById('earthquakeAlert');
            earthquakeAlertP.innerHTML = data.earthquakeAlert 
                ? '<i class="fas fa-exclamation-triangle"></i> YES!' 
                : '<i class="fas fa-check-circle"></i> NO';
            earthquakeCard.classList.toggle('alert', data.earthquakeAlert);
            earthquakeCard.classList.toggle('pulse', data.earthquakeAlert); 

            const weakBrickCard = document.getElementById('weakBrickCard');
            const weakBrickWarningP = document.getElementById('weakBrickWarning');
            weakBrickWarningP.innerHTML = data.weakBrickWarning 
                ? '<i class="fas fa-exclamation-circle"></i> YES' 
                : '<i class="fas fa-check-circle"></i> NO';
            weakBrickCard.classList.toggle('warning', data.weakBrickWarning);
            weakBrickCard.classList.toggle('pulse', data.weakBrickWarning); 
            
            const timestamp = new Date().toLocaleTimeString();
            updateChart(tempChart, timestamp, data.surfaceTemp, data.innerTemp);
            updateChart(accelChart, timestamp, data.accelX, data.accelY, data.accelZ);

            const logBox = document.getElementById('log-box');
            logBox.innerHTML = '';
            if (logs && logs.length > 0) {
                logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `<span class="timestamp">${log.timestamp}</span>${log.message}`;
                    logBox.appendChild(logEntry);
                });
            } else {
                logBox.innerHTML = '<div class="log-entry">No events recorded.</div>';
            }

        } catch (error) {
            console.error('Failed to fetch sensor data:', error);
        }
    }

    const themeToggle = document.getElementById('checkbox');
    const currentTheme = localStorage.getItem('theme');

    function applyTheme(theme) {
        // --- MODIFIED: Added .trim() to fix color parsing errors ---
        const newTextColor = getComputedStyle(document.body).getPropertyValue('--text-color').trim();
        const newGridColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim();

        [tempChart, accelChart].forEach(chart => {
            chart.options.scales.y.ticks.color = newTextColor;
            chart.options.scales.y.grid.color = newGridColor;
            chart.options.scales.x.ticks.color = newTextColor;
            chart.options.scales.x.grid.color = newGridColor;
            chart.options.plugins.legend.labels.color = newTextColor;
            chart.update('none'); 
        });
    }

    // Initial load theme application
    if (currentTheme) {
        document.body.classList.add(currentTheme);
        if (currentTheme === 'dark-mode') {
            themeToggle.checked = true;
        }
    }
    
    requestAnimationFrame(() => {
        applyTheme(currentTheme || 'light-mode');
    });
    

    themeToggle.addEventListener('change', () => {
        let theme;
        if (themeToggle.checked) {
            document.body.classList.add('dark-mode');
            theme = 'dark-mode';
            localStorage.setItem('theme', 'dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
            theme = 'light-mode';
            localStorage.setItem('theme', 'light-mode');
        }
        
        requestAnimationFrame(() => {
            applyTheme(theme); 
        });
    });

    setInterval(fetchData, 2000);
    fetchData(); // Initial fetch
</script>
</body>
</html>
